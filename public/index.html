<h1>Video Thumbnailer</h1>

<label for="folderPath">Folder path:</label>
<input type="text" id="folderPath" value="/data" style="width:400px">
<button onclick="loadFiles()">Load Videos</button>

<h2>Videos in folder (select multiple):</h2>
<div id="fileList"></div>
<button onclick="enqueueSelected()">Add selected files to queue</button>

<h2>Job Queue:</h2>
<div id="jobs"></div>

<script>
let selectedFiles = [];

async function loadFiles() {
  const folder = document.getElementById("folderPath").value;
  const res = await fetch(`/api/list?dir=${encodeURIComponent(folder)}`);
  const files = await res.json();
  const fileListDiv = document.getElementById("fileList");
  fileListDiv.innerHTML = "";
  selectedFiles = [];

  files.forEach(f => {
    const fileDiv = document.createElement("div");
    const checkbox = document.createElement("input");
    checkbox.type = "checkbox";
    checkbox.value = f;
    checkbox.onchange = e => {
      if(e.target.checked) selectedFiles.push(f);
      else selectedFiles = selectedFiles.filter(x => x !== f);
    };
    fileDiv.appendChild(checkbox);
    fileDiv.appendChild(document.createTextNode(" " + f));
    fileListDiv.appendChild(fileDiv);
  });
}

async function enqueueSelected() {
  for (const f of selectedFiles) {
    await fetch("/api/enqueue", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ file: f })
    });
  }
  selectedFiles = [];
}

async function refreshJobs() {
  const res = await fetch("/api/jobs");
  const jobs = await res.json();
  const jobsDiv = document.getElementById("jobs");
  jobsDiv.innerHTML = "";
  jobs.forEach(j => {
    jobsDiv.innerHTML += `
      <div style="margin-bottom:10px;">
        ${j.input} - ${j.status}
        <progress value="${j.progress}" max="100"></progress>
        ${j.status === "done" ? `<br><img src="${j.output.replace("/data","")}" width="300">` : ""}
      </div>
    `;
  });
}

setInterval(refreshJobs, 1000);
</script>
